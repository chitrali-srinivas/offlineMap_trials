<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FarmMap Admin</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  :root {
    --bg: #0f1117; --panel: #1a1d27; --card: #222536;
    --border: #2e3147; --accent: #4f7cff; --accent2: #00d4aa;
    --text: #e8eaf0; --muted: #7b7f9e; --danger: #ff5b5b; --success: #00d4aa;
    --warn: #f5a623;
  }
  body { font-family: 'Inter', system-ui, sans-serif; background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; }

  /* LOGIN */
  #login-screen {
    display: flex; align-items: center; justify-content: center;
    height: 100vh; background: var(--bg);
  }
  .login-card {
    background: var(--panel); border: 1px solid var(--border);
    border-radius: 16px; padding: 48px 40px; width: 380px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.5);
  }
  .login-logo { display: flex; align-items: center; gap: 10px; margin-bottom: 32px; }
  .login-logo .icon { width: 40px; height: 40px; background: var(--accent); border-radius: 10px;
    display: flex; align-items: center; justify-content: center; font-size: 20px; }
  .login-logo h1 { font-size: 22px; font-weight: 700; }
  .login-logo span { color: var(--muted); font-size: 13px; display: block; }
  label { display: block; font-size: 12px; font-weight: 600; color: var(--muted);
    text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; }
  input[type=text], input[type=password], input[type=url], select, textarea {
    width: 100%; background: var(--bg); border: 1px solid var(--border);
    border-radius: 8px; padding: 10px 14px; color: var(--text); font-size: 14px;
    outline: none; transition: border-color 0.2s;
  }
  input:focus, select:focus, textarea:focus { border-color: var(--accent); }
  .field { margin-bottom: 18px; }
  .btn {
    width: 100%; padding: 12px; background: var(--accent); color: #fff;
    border: none; border-radius: 8px; font-size: 15px; font-weight: 600;
    cursor: pointer; transition: opacity 0.2s;
  }
  .btn:hover { opacity: 0.85; }
  .btn-outline {
    background: transparent; border: 1px solid var(--border); color: var(--text);
  }
  .btn-outline:hover { border-color: var(--accent); color: var(--accent); opacity: 1; }
  .btn-sm { width: auto; padding: 8px 16px; font-size: 13px; border-radius: 6px; }
  .btn-danger { background: var(--danger); }
  .btn-success { background: var(--success); color: #000; }
  .login-err { color: var(--danger); font-size: 13px; margin-top: 12px; text-align: center; display: none; }

  /* APP SHELL */
  #app { display: none; height: 100vh; flex-direction: column; }
  .topbar {
    height: 56px; background: var(--panel); border-bottom: 1px solid var(--border);
    display: flex; align-items: center; padding: 0 20px; gap: 16px; flex-shrink: 0;
  }
  .topbar-logo { display: flex; align-items: center; gap: 8px; font-weight: 700; font-size: 16px; }
  .topbar-logo .dot { width: 8px; height: 8px; background: var(--accent2); border-radius: 50%; }
  .topbar-nav { display: flex; gap: 4px; margin-left: 24px; }
  .nav-btn {
    padding: 6px 14px; border-radius: 6px; font-size: 13px; font-weight: 500;
    cursor: pointer; border: none; background: transparent; color: var(--muted); transition: all 0.2s;
  }
  .nav-btn.active { background: var(--card); color: var(--text); }
  .nav-btn:hover:not(.active) { color: var(--text); }
  .topbar-right { margin-left: auto; display: flex; align-items: center; gap: 12px; }
  .badge { background: var(--card); border: 1px solid var(--border); border-radius: 20px;
    padding: 4px 12px; font-size: 12px; color: var(--muted); }
  .surveyor-link {
    padding: 7px 14px; background: var(--accent2); color: #000; border-radius: 6px;
    font-size: 13px; font-weight: 600; text-decoration: none;
  }

  /* MAIN LAYOUT */
  .main { display: flex; flex: 1; overflow: hidden; }

  /* SIDEBAR */
  .sidebar {
    width: 380px; flex-shrink: 0; background: var(--panel);
    border-right: 1px solid var(--border); display: flex; flex-direction: column; overflow: hidden;
  }
  .sidebar-tabs { display: flex; border-bottom: 1px solid var(--border); }
  .stab {
    flex: 1; padding: 12px; text-align: center; font-size: 13px; font-weight: 500;
    cursor: pointer; color: var(--muted); border-bottom: 2px solid transparent;
    transition: all 0.2s;
  }
  .stab.active { color: var(--accent); border-bottom-color: var(--accent); }
  .sidebar-content { flex: 1; overflow-y: auto; padding: 20px; }
  .sidebar-content::-webkit-scrollbar { width: 4px; }
  .sidebar-content::-webkit-scrollbar-track { background: transparent; }
  .sidebar-content::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

  /* FORM SECTIONS */
  .section-title { font-size: 11px; font-weight: 700; color: var(--muted);
    text-transform: uppercase; letter-spacing: 0.8px; margin-bottom: 14px; }
  .field-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
  .map-source-selector { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 18px; }
  .map-option {
    border: 2px solid var(--border); border-radius: 10px; padding: 12px;
    cursor: pointer; transition: all 0.2s; text-align: center;
  }
  .map-option:hover { border-color: var(--accent); }
  .map-option.selected { border-color: var(--accent); background: rgba(79,124,255,0.1); }
  .map-option .mo-icon { font-size: 24px; margin-bottom: 6px; }
  .map-option .mo-name { font-size: 13px; font-weight: 600; }
  .map-option .mo-desc { font-size: 11px; color: var(--muted); margin-top: 2px; }
  .quality-bar {
    background: var(--card); border: 1px solid var(--border); border-radius: 10px;
    padding: 14px; margin-bottom: 18px;
  }
  .quality-label { font-size: 12px; color: var(--muted); margin-bottom: 8px; }
  .quality-stars { display: flex; gap: 4px; }
  .star { font-size: 18px; cursor: pointer; color: var(--border); transition: color 0.2s; }
  .star.lit { color: var(--warn); }
  .quality-feedback { font-size: 12px; margin-top: 8px; }
  .divider { height: 1px; background: var(--border); margin: 20px 0; }
  .action-row { display: flex; gap: 10px; }

  /* VILLAGE LIST */
  .village-card {
    background: var(--card); border: 1px solid var(--border); border-radius: 10px;
    padding: 14px; margin-bottom: 10px; cursor: pointer; transition: border-color 0.2s;
  }
  .village-card:hover { border-color: var(--accent); }
  .village-card.has-boundary { border-left: 3px solid var(--success); }
  .vc-name { font-size: 15px; font-weight: 600; margin-bottom: 4px; }
  .vc-meta { font-size: 12px; color: var(--muted); }
  .vc-status { display: flex; align-items: center; gap: 6px; margin-top: 8px; }
  .status-dot { width: 7px; height: 7px; border-radius: 50%; }
  .status-dot.green { background: var(--success); }
  .status-dot.orange { background: var(--warn); }
  .status-text { font-size: 12px; color: var(--muted); }

  /* SETTINGS */
  .settings-group { background: var(--card); border: 1px solid var(--border);
    border-radius: 10px; padding: 16px; margin-bottom: 16px; }
  .sg-title { font-size: 12px; font-weight: 700; color: var(--muted);
    text-transform: uppercase; letter-spacing: 0.6px; margin-bottom: 14px; }
  .key-display { font-family: monospace; font-size: 12px; background: var(--bg);
    border: 1px solid var(--border); border-radius: 6px; padding: 8px 12px;
    color: var(--muted); word-break: break-all; }

  /* MAP CONTAINER */
  #map-container { flex: 1; position: relative; background: #0a0c12; }
  #map { width: 100%; height: 100%; }
  .map-overlay {
    position: absolute; top: 16px; right: 16px; z-index: 1000;
    display: flex; flex-direction: column; gap: 8px;
  }
  .map-pill {
    background: var(--panel); border: 1px solid var(--border); border-radius: 8px;
    padding: 8px 14px; font-size: 12px; font-weight: 600; color: var(--text);
    display: flex; align-items: center; gap: 6px;
  }
  .map-pill .dot { width: 8px; height: 8px; border-radius: 50%; background: var(--success); }
  #loading-overlay {
    position: absolute; inset: 0; background: rgba(15,17,23,0.85);
    display: none; align-items: center; justify-content: center;
    flex-direction: column; gap: 16px; z-index: 2000;
  }
  .spinner {
    width: 40px; height: 40px; border: 3px solid var(--border);
    border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  .loading-text { font-size: 14px; color: var(--muted); }

  .toast {
    position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%);
    background: var(--card); border: 1px solid var(--border); border-radius: 10px;
    padding: 12px 24px; font-size: 14px; font-weight: 500;
    z-index: 9999; opacity: 0; transition: opacity 0.3s; pointer-events: none;
  }
  .toast.show { opacity: 1; }
  .toast.success { border-color: var(--success); color: var(--success); }
  .toast.warn { border-color: var(--warn); color: var(--warn); }
  .toast.error { border-color: var(--danger); color: var(--danger); }

  .empty-state { text-align: center; padding: 40px 20px; color: var(--muted); }
  .empty-state .es-icon { font-size: 40px; margin-bottom: 12px; }
  .empty-state p { font-size: 13px; line-height: 1.6; }

  select option { background: var(--panel); }
</style>
</head>
<body>

<!-- LOGIN -->
<div id="login-screen">
  <div class="login-card">
    <div class="login-logo">
      <div class="icon">üåæ</div>
      <div>
        <h1>FarmMap</h1>
        <span>Admin Dashboard</span>
      </div>
    </div>
    <div class="field">
      <label>Username</label>
      <input type="text" id="login-user" placeholder="admin" autocomplete="username"/>
    </div>
    <div class="field">
      <label>Password</label>
      <input type="password" id="login-pass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password"/>
    </div>
    <button class="btn" onclick="doLogin()">Sign In</button>
    <div class="login-err" id="login-err">Invalid credentials</div>
  </div>
</div>

<!-- APP -->
<div id="app">
  <div class="topbar">
    <div class="topbar-logo">
      <span>üåæ</span> FarmMap
      <div class="dot"></div>
    </div>
    <div class="topbar-nav">
      <button class="nav-btn active" id="nav-villages" onclick="switchTab('villages')">Villages</button>
      <button class="nav-btn" id="nav-settings" onclick="switchTab('settings')">Settings</button>
    </div>
    <div class="topbar-right">
      <span class="badge" id="village-count">0 villages</span>
      <a href="/surveyor" target="_blank" class="surveyor-link">‚Üó Surveyor App</a>
    </div>
  </div>

  <div class="main">
    <!-- SIDEBAR -->
    <div class="sidebar">

      <!-- VILLAGES TAB -->
      <div id="tab-villages">
        <div class="sidebar-tabs">
          <div class="stab active" id="stab-add" onclick="switchSideTab('add')">+ Add Village</div>
          <div class="stab" id="stab-list" onclick="switchSideTab('list')">Village List</div>
        </div>

        <!-- ADD FORM -->
        <div class="sidebar-content" id="side-add">
          <div class="section-title">Location Details</div>
          <div class="field">
            <label>Country</label>
            <input type="text" id="f-country" placeholder="India" value="India"/>
          </div>
          <div class="field-row">
            <div class="field">
              <label>State</label>
              <input type="text" id="f-state" placeholder="e.g. Maharashtra"/>
            </div>
            <div class="field">
              <label>District</label>
              <input type="text" id="f-district" placeholder="e.g. Pune"/>
            </div>
          </div>
          <div class="field-row">
            <div class="field">
              <label>Block</label>
              <input type="text" id="f-block" placeholder="e.g. Haveli"/>
            </div>
            <div class="field">
              <label>Tehsil</label>
              <input type="text" id="f-tehsil" placeholder="e.g. Mulshi"/>
            </div>
          </div>
          <div class="field">
            <label>Village Name</label>
            <input type="text" id="f-village" placeholder="e.g. Paud" oninput="onVillageInput()"/>
          </div>

          <div class="divider"></div>
          <div class="section-title">Basemap Source</div>
          <div class="map-source-selector">
            <div class="map-option selected" id="opt-mapbox" onclick="selectMapSource('mapbox')">
              <div class="mo-icon">üó∫Ô∏è</div>
              <div class="mo-name">Mapbox</div>
              <div class="mo-desc">Satellite + Streets</div>
            </div>
            <div class="map-option" id="opt-google" onclick="selectMapSource('google')">
              <div class="mo-icon">üåç</div>
              <div class="mo-name">Google Maps</div>
              <div class="mo-desc">Satellite imagery</div>
            </div>
          </div>

          <div class="quality-bar">
            <div class="quality-label">Rate basemap quality for this area</div>
            <div class="quality-stars" id="quality-stars">
              <span class="star" onclick="setQuality(1)">‚òÖ</span>
              <span class="star" onclick="setQuality(2)">‚òÖ</span>
              <span class="star" onclick="setQuality(3)">‚òÖ</span>
              <span class="star" onclick="setQuality(4)">‚òÖ</span>
              <span class="star" onclick="setQuality(5)">‚òÖ</span>
            </div>
            <div class="quality-feedback" id="quality-feedback"></div>
          </div>

          <div class="action-row">
            <button class="btn btn-outline btn-sm" onclick="previewMap()" style="flex:1">Preview Map</button>
            <button class="btn btn-sm" onclick="generateBoundary()" style="flex:1" id="gen-btn">Generate Boundary</button>
          </div>
          <div style="height:12px"></div>
          <button class="btn btn-success" onclick="saveVillage()" id="save-btn" style="display:none">Save Village</button>
        </div>

        <!-- LIST -->
        <div class="sidebar-content" id="side-list" style="display:none">
          <div class="section-title">All Villages</div>
          <div id="village-list-container">
            <div class="empty-state">
              <div class="es-icon">üèòÔ∏è</div>
              <p>No villages added yet.<br/>Use the Add tab to create your first village.</p>
            </div>
          </div>
        </div>
      </div>

      <!-- SETTINGS TAB -->
      <div id="tab-settings" style="display:none">
        <div class="sidebar-content">
          <div class="section-title">API Configuration</div>

          <div class="settings-group">
            <div class="sg-title">üü£ Supabase</div>
            <div class="field">
              <label>Project URL</label>
              <input type="url" id="s-supa-url" placeholder="https://xxxx.supabase.co"/>
            </div>
            <div class="field">
              <label>Anon / Public Key</label>
              <input type="text" id="s-supa-key" placeholder="eyJhbGciOiJ..."/>
            </div>
          </div>

          <div class="settings-group">
            <div class="sg-title">üîµ Mapbox</div>
            <div class="field">
              <label>Access Token</label>
              <input type="text" id="s-mapbox" placeholder="pk.eyJ1..."/>
            </div>
          </div>

          <div class="settings-group">
            <div class="sg-title">üî¥ Google Maps</div>
            <div class="field">
              <label>API Key</label>
              <input type="text" id="s-google" placeholder="AIzaSy..."/>
            </div>
          </div>

          <button class="btn" onclick="saveSettings()">Save & Apply Settings</button>
          <div style="height:12px"></div>
          <div style="font-size:12px; color:var(--muted); line-height:1.7">
            Keys are stored in your Supabase <code>app_config</code> table. After saving, they persist across sessions and devices.
          </div>

          <div class="divider"></div>
          <div class="section-title">Supabase Setup SQL</div>
          <div style="font-size:12px; color:var(--muted); margin-bottom:10px">Run this once in your Supabase SQL editor:</div>
          <textarea readonly style="height:220px; font-size:11px; font-family:monospace; resize:none;" id="setup-sql"></textarea>
          <button class="btn btn-outline btn-sm" style="margin-top:8px; width:100%" onclick="copySQL()">Copy SQL</button>
        </div>
      </div>

    </div>

    <!-- MAP -->
    <div id="map-container">
      <div id="map"></div>
      <div class="map-overlay">
        <div class="map-pill" id="map-source-pill">
          <div class="dot"></div>
          <span id="map-source-label">Mapbox Satellite</span>
        </div>
        <div class="map-pill" id="boundary-pill" style="display:none">
          <span>‚úÖ Boundary loaded</span>
        </div>
      </div>
      <div id="loading-overlay">
        <div class="spinner"></div>
        <div class="loading-text" id="loading-text">Fetching boundary data...</div>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script src="config.js"></script>
<script>
// ‚îÄ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function doLogin() {
  const u = document.getElementById('login-user').value.trim();
  const p = document.getElementById('login-pass').value.trim();
  if (u === 'srini' && p === 'srini') {
    document.getElementById('login-screen').style.display = 'none';
    document.getElementById('app').style.display = 'flex';
    initApp();
  } else {
    document.getElementById('login-err').style.display = 'block';
  }
}
document.getElementById('login-pass').addEventListener('keydown', e => { if (e.key === 'Enter') doLogin(); });

// ‚îÄ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let map, currentLayer = null, boundaryLayer = null;
let currentMapSource = 'mapbox';
let currentQuality = 0;
let currentBoundaryGeoJSON = null;
let villages = [];
let cfg = {};
let db = null;

const SETUP_SQL = `-- Run once in Supabase SQL editor

create table if not exists app_config (
  key text primary key,
  value text
);

create table if not exists villages (
  id uuid default gen_random_uuid() primary key,
  name text not null,
  country text,
  state text,
  district text,
  block text,
  tehsil text,
  map_source text,
  quality_rating int,
  boundary_geojson jsonb,
  created_at timestamptz default now()
);

-- Allow public read/write for demo (tighten for production)
alter table app_config enable row level security;
alter table villages enable row level security;

create policy "allow_all_config" on app_config for all using (true) with check (true);
create policy "allow_all_villages" on villages for all using (true) with check (true);`;

document.getElementById('setup-sql').value = SETUP_SQL;

// ‚îÄ‚îÄ‚îÄ CONFIG (localStorage) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function getConfig() {
  try { return JSON.parse(localStorage.getItem('farmmap_cfg') || '{}'); } catch(e) { return {}; }
}
function saveConfig(c) {
  try { localStorage.setItem('farmmap_cfg', JSON.stringify(c)); } catch(e) {}
}

// ‚îÄ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function initApp() {
  initMap();
  const localCfg = getConfig();
  if (localCfg) {
    cfg = localCfg;
    applySettingsToForm();
    initDB();
    await loadVillages();
  }
  switchTab('villages');
}

function initDB() {
  if (cfg.supabaseUrl && cfg.supabaseKey) {
    db = supabaseClient(cfg.supabaseUrl, cfg.supabaseKey);
  }
}

// ‚îÄ‚îÄ‚îÄ MAP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function initMap() {
  map = L.map('map', { zoomControl: true }).setView([20.5937, 78.9629], 5);
  applyMapSource('mapbox');
}

function applyMapSource(source) {
  if (currentLayer) map.removeLayer(currentLayer);

  if (source === 'mapbox' && cfg.mapboxToken) {
    currentLayer = L.tileLayer(
      `https://api.mapbox.com/styles/v1/mapbox/satellite-streets-v12/tiles/{z}/{x}/{y}?access_token=${cfg.mapboxToken}`,
      { tileSize: 512, zoomOffset: -1, attribution: '¬© Mapbox', maxZoom: 22 }
    ).addTo(map);
    document.getElementById('map-source-label').textContent = 'Mapbox Satellite';
  } else if (source === 'google' && cfg.googleKey) {
    currentLayer = L.tileLayer(
      `https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}&key=${cfg.googleKey}`,
      { attribution: '¬© Google', maxZoom: 22 }
    ).addTo(map);
    document.getElementById('map-source-label').textContent = 'Google Satellite';
  } else {
    // fallback: OSM
    currentLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
      { attribution: '¬© OpenStreetMap' }
    ).addTo(map);
    document.getElementById('map-source-label').textContent = 'OSM (no key set)';
  }
}

function selectMapSource(src) {
  currentMapSource = src;
  document.querySelectorAll('.map-option').forEach(el => el.classList.remove('selected'));
  document.getElementById('opt-' + src).classList.add('selected');
  applyMapSource(src);
  if (currentBoundaryGeoJSON) drawBoundary(currentBoundaryGeoJSON);
}

function previewMap() {
  const village = document.getElementById('f-village').value.trim();
  const state = document.getElementById('f-state').value.trim();
  const district = document.getElementById('f-district').value.trim();
  if (!village) { showToast('Enter a village name first', 'error'); return; }
  const query = [village, district, state, 'India'].filter(Boolean).join(', ');
  geocodeAndZoom(query);
}

async function geocodeAndZoom(query) {
  showLoading('Locating on map...');
  try {
    const url = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&limit=1`;
    const res = await fetch(url, { headers: { 'Accept-Language': 'en' } });
    const data = await res.json();
    if (data && data.length > 0) {
      map.setView([parseFloat(data[0].lat), parseFloat(data[0].lon)], 13);
    } else {
      showToast('Location not found ‚Äî try adjusting fields', 'error');
    }
  } catch(e) { showToast('Geocoding failed', 'error'); }
  hideLoading();
}

async function generateBoundary() {
  const village = document.getElementById('f-village').value.trim();
  const tehsil = document.getElementById('f-tehsil').value.trim();
  const district = document.getElementById('f-district').value.trim();
  const state = document.getElementById('f-state').value.trim();
  if (!village) { showToast('Enter a village name first', 'error'); return; }

  showLoading('Fetching village boundary from OpenStreetMap...');

  // Try OSM Nominatim for boundary polygon
  const queries = [
    `${village}, ${tehsil}, ${district}, ${state}, India`,
    `${village}, ${district}, ${state}, India`,
    `${village}, ${state}, India`
  ];

  let found = false;
  for (const q of queries) {
    try {
      const res = await fetch(
        `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(q)}&format=geojson&polygon_geojson=1&limit=5`,
        { headers: { 'Accept-Language': 'en' } }
      );
      const data = await res.json();
      if (data.features && data.features.length > 0) {
        // Prefer polygon/multipolygon features
        const poly = data.features.find(f =>
          f.geometry && (f.geometry.type === 'Polygon' || f.geometry.type === 'MultiPolygon')
        );
        if (poly) {
          currentBoundaryGeoJSON = poly;
          drawBoundary(poly);
          found = true;
          break;
        }
      }
    } catch(e) { console.error(e); }
  }

  if (!found) {
    // Fallback: try Overpass API for village boundary
    await tryOverpass(village, district, state);
  }

  hideLoading();
}

async function tryOverpass(village, district, state) {
  showLoading('Trying Overpass API...');

  // Try multiple name variants
  const variants = [village, village.toLowerCase(), village.toUpperCase()];
  for (const name of variants) {
    const query = `[out:json][timeout:25];
(
  relation["name"="${name}"]["boundary"="administrative"];
  relation["name"="${name}"]["place"~"village|hamlet|town"];
  way["name"="${name}"]["place"~"village|hamlet"];
);
out geom;`;
    try {
      const res = await fetch('https://overpass-api.de/api/interpreter', {
        method: 'POST', body: 'data=' + encodeURIComponent(query)
      });
      const data = await res.json();
      if (data.elements && data.elements.length > 0) {
        const geojson = overpassToGeoJSON(data.elements[0]);
        if (geojson) {
          currentBoundaryGeoJSON = geojson;
          drawBoundary(geojson);
          return;
        }
      }
    } catch(e) { console.error(e); }
  }

  // Final fallback: geocode the village and draw an approximate circle boundary
  showLoading('Drawing approximate boundary from location...');
  try {
    const q = [village, district, state, 'India'].filter(Boolean).join(', ');
    const res = await fetch(
      `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(q)}&format=json&limit=1`,
      { headers: { 'Accept-Language': 'en' } }
    );
    const data = await res.json();
    if (data && data.length > 0) {
      const lat = parseFloat(data[0].lat);
      const lon = parseFloat(data[0].lon);
      const circle = createCircleBoundary(lat, lon, 1.2, village);
      currentBoundaryGeoJSON = circle;
      drawBoundary(circle);
      showToast('Exact boundary not in OSM ‚Äî approximate area drawn. Adjust if needed.', 'warn');
      return;
    }
  } catch(e) { console.error(e); }

  showToast('Village not found. Check spelling or try Preview Map first.', 'error');
}

function createCircleBoundary(lat, lng, radiusKm, name) {
  const points = 64;
  const coords = [];
  for (let i = 0; i <= points; i++) {
    const angle = (i / points) * 2 * Math.PI;
    const dlat = (radiusKm / 111.32) * Math.cos(angle);
    const dlng = (radiusKm / (111.32 * Math.cos(lat * Math.PI / 180))) * Math.sin(angle);
    coords.push([lng + dlng, lat + dlat]);
  }
  return {
    type: 'Feature',
    geometry: { type: 'Polygon', coordinates: [coords] },
    properties: { name, source: 'Approximate' }
  };
}

function overpassToGeoJSON(el) {
  if (!el.members) return null;
  const outerWay = el.members.filter(m => m.role === 'outer' && m.geometry);
  if (!outerWay.length) return null;
  const coords = outerWay[0].geometry.map(p => [p.lon, p.lat]);
  return {
    type: 'Feature',
    geometry: { type: 'Polygon', coordinates: [coords] },
    properties: { name: el.tags?.name || '' }
  };
}

function drawBoundary(geojson) {
  if (boundaryLayer) map.removeLayer(boundaryLayer);
  boundaryLayer = L.geoJSON(geojson, {
    style: {
      color: '#4f7cff', weight: 3, opacity: 1,
      fillColor: '#4f7cff', fillOpacity: 0.12
    }
  }).addTo(map);
  map.fitBounds(boundaryLayer.getBounds(), { padding: [40, 40] });
  document.getElementById('boundary-pill').style.display = 'flex';
  document.getElementById('save-btn').style.display = 'block';
  showToast('Boundary generated successfully', 'success');
}

// ‚îÄ‚îÄ‚îÄ QUALITY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setQuality(n) {
  currentQuality = n;
  const stars = document.querySelectorAll('.star');
  stars.forEach((s, i) => s.classList.toggle('lit', i < n));
  const msgs = ['', 'Poor ‚Äî consider switching source', 'Below average', 'Acceptable', 'Good quality', 'Excellent!'];
  document.getElementById('quality-feedback').textContent = msgs[n];
  document.getElementById('quality-feedback').style.color =
    n < 3 ? 'var(--danger)' : n < 4 ? 'var(--warn)' : 'var(--success)';
}

function onVillageInput() {
  currentBoundaryGeoJSON = null;
  if (boundaryLayer) { map.removeLayer(boundaryLayer); boundaryLayer = null; }
  document.getElementById('boundary-pill').style.display = 'none';
  document.getElementById('save-btn').style.display = 'none';
}

// ‚îÄ‚îÄ‚îÄ SAVE VILLAGE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function saveVillage() {
  if (!currentBoundaryGeoJSON) { showToast('Generate boundary first', 'error'); return; }

  const village = {
    name: document.getElementById('f-village').value.trim(),
    country: document.getElementById('f-country').value.trim(),
    state: document.getElementById('f-state').value.trim(),
    district: document.getElementById('f-district').value.trim(),
    block: document.getElementById('f-block').value.trim(),
    tehsil: document.getElementById('f-tehsil').value.trim(),
    map_source: currentMapSource,
    quality_rating: currentQuality,
    boundary_geojson: currentBoundaryGeoJSON
  };

  if (!village.name) { showToast('Village name is required', 'error'); return; }

  if (db) {
    showLoading('Saving to Supabase...');
    try {
      const result = await db.from('villages').insert(village);
      if (Array.isArray(result) && result[0]?.id) {
        villages.push(result[0]);
      } else {
        village.id = Date.now().toString();
        villages.push(village);
      }
    } catch(e) {
      village.id = Date.now().toString();
      villages.push(village);
    }
    hideLoading();
  } else {
    village.id = Date.now().toString();
    villages.push(village);
    showToast('Saved locally (no Supabase configured)', 'error');
  }

  renderVillageList();
  updateVillageCount();
  showToast(`Village "${village.name}" saved!`, 'success');
  switchSideTab('list');
}

// ‚îÄ‚îÄ‚îÄ LOAD VILLAGES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadVillages() {
  if (!db) return;
  try {
    const data = await db.from('villages').select('*');
    if (Array.isArray(data)) {
      villages = data;
      renderVillageList();
      updateVillageCount();
    }
  } catch(e) { console.error(e); }
}

function renderVillageList() {
  const container = document.getElementById('village-list-container');
  if (!villages.length) {
    container.innerHTML = `<div class="empty-state"><div class="es-icon">üèòÔ∏è</div><p>No villages yet.</p></div>`;
    return;
  }
  container.innerHTML = villages.map(v => `
    <div class="village-card ${v.boundary_geojson ? 'has-boundary' : ''}" onclick="viewVillage('${v.id}')">
      <div class="vc-name">${v.name}</div>
      <div class="vc-meta">${[v.block, v.district, v.state].filter(Boolean).join(' ¬∑ ')}</div>
      <div class="vc-status">
        <div class="status-dot ${v.boundary_geojson ? 'green' : 'orange'}"></div>
        <div class="status-text">${v.boundary_geojson ? 'Boundary saved' : 'No boundary'} ¬∑ ${v.map_source || 'mapbox'}</div>
      </div>
    </div>
  `).join('');
}

function viewVillage(id) {
  const v = villages.find(x => x.id == id);
  if (!v) return;
  selectMapSource(v.map_source || 'mapbox');
  if (v.boundary_geojson) drawBoundary(v.boundary_geojson);
}

function updateVillageCount() {
  document.getElementById('village-count').textContent = `${villages.length} village${villages.length !== 1 ? 's' : ''}`;
}

// ‚îÄ‚îÄ‚îÄ SETTINGS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function applySettingsToForm() {
  if (cfg.supabaseUrl) document.getElementById('s-supa-url').value = cfg.supabaseUrl;
  if (cfg.supabaseKey) document.getElementById('s-supa-key').value = cfg.supabaseKey;
  if (cfg.mapboxToken) document.getElementById('s-mapbox').value = cfg.mapboxToken;
  if (cfg.googleKey) document.getElementById('s-google').value = cfg.googleKey;
}

async function saveSettings() {
  const newCfg = {
    supabaseUrl: document.getElementById('s-supa-url').value.trim(),
    supabaseKey: document.getElementById('s-supa-key').value.trim(),
    mapboxToken: document.getElementById('s-mapbox').value.trim(),
    googleKey: document.getElementById('s-google').value.trim()
  };

  saveConfig(newCfg);
  cfg = newCfg;
  initDB();

  // Try to persist keys to Supabase config table
  if (db) {
    showLoading('Saving config...');
    try {
      for (const [key, value] of Object.entries(newCfg)) {
        await db.from('app_config').upsert({ key, value });
      }
    } catch(e) { console.error(e); }
    hideLoading();
    await loadVillages();
  }

  applyMapSource(currentMapSource);
  showToast('Settings saved!', 'success');
  switchTab('villages');
}

function copySQL() {
  navigator.clipboard.writeText(SETUP_SQL).then(() => showToast('SQL copied!', 'success'));
}

// ‚îÄ‚îÄ‚îÄ NAV ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function switchTab(tab) {
  document.getElementById('tab-villages').style.display = tab === 'villages' ? 'flex' : 'none';
  document.getElementById('tab-villages').style.flexDirection = 'column';
  document.getElementById('tab-settings').style.display = tab === 'settings' ? 'block' : 'none';
  document.getElementById('nav-villages').classList.toggle('active', tab === 'villages');
  document.getElementById('nav-settings').classList.toggle('active', tab === 'settings');
  if (tab === 'settings') applySettingsToForm();
}

function switchSideTab(tab) {
  document.getElementById('side-add').style.display = tab === 'add' ? 'block' : 'none';
  document.getElementById('side-list').style.display = tab === 'list' ? 'block' : 'none';
  document.getElementById('stab-add').classList.toggle('active', tab === 'add');
  document.getElementById('stab-list').classList.toggle('active', tab === 'list');
}

// ‚îÄ‚îÄ‚îÄ UTILS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showLoading(text = 'Loading...') {
  document.getElementById('loading-text').textContent = text;
  document.getElementById('loading-overlay').style.display = 'flex';
}
function hideLoading() {
  document.getElementById('loading-overlay').style.display = 'none';
}

let toastTimer;
function showToast(msg, type = 'success') {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = `toast ${type} show`;
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => t.classList.remove('show'), 3000);
}
</script>
</body>
</html>
