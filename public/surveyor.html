<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#0f1117">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="FarmMap">
<link rel="manifest" href="/manifest.json">
<title>FarmMap Surveyor</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  :root {
    --bg: #0f1117; --panel: #1a1d27; --card: #222536;
    --border: #2e3147; --accent: #4f7cff; --accent2: #00d4aa;
    --text: #e8eaf0; --muted: #7b7f9e; --danger: #ff5b5b; --success: #00d4aa;
  }
  html, body { height: 100%; background: var(--bg); color: var(--text); font-family: system-ui, sans-serif; overflow: hidden; }

  /* SPLASH */
  #splash {
    position: fixed; inset: 0; background: var(--bg);
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    z-index: 9999; gap: 16px;
  }
  .splash-icon { font-size: 56px; }
  .splash-title { font-size: 28px; font-weight: 800; }
  .splash-sub { font-size: 14px; color: var(--muted); }
  .spinner { width: 36px; height: 36px; border: 3px solid var(--border);
    border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; margin-top: 8px; }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* VILLAGE SELECT SCREEN */
  #select-screen {
    display: none; position: fixed; inset: 0; background: var(--bg);
    flex-direction: column; z-index: 100;
  }
  .ss-header {
    background: var(--panel); border-bottom: 1px solid var(--border);
    padding: 16px 20px; display: flex; align-items: center; gap: 12px;
  }
  .ss-header h2 { font-size: 18px; font-weight: 700; }
  .ss-header p { font-size: 13px; color: var(--muted); }
  .ss-body { flex: 1; overflow-y: auto; padding: 20px; }
  .search-box {
    width: 100%; background: var(--card); border: 1px solid var(--border);
    border-radius: 10px; padding: 12px 16px; color: var(--text); font-size: 15px;
    margin-bottom: 16px; outline: none;
  }
  .search-box:focus { border-color: var(--accent); }
  .village-item {
    background: var(--card); border: 1px solid var(--border); border-radius: 12px;
    padding: 16px; margin-bottom: 10px; cursor: pointer;
    display: flex; align-items: center; gap: 14px; transition: border-color 0.2s;
  }
  .village-item:hover, .village-item:active { border-color: var(--accent); }
  .vi-icon { width: 42px; height: 42px; background: rgba(79,124,255,0.15);
    border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 20px; flex-shrink: 0; }
  .vi-name { font-size: 16px; font-weight: 600; }
  .vi-meta { font-size: 12px; color: var(--muted); margin-top: 2px; }
  .vi-status { margin-left: auto; }
  .vi-badge {
    background: rgba(0,212,170,0.15); color: var(--success);
    border-radius: 6px; padding: 3px 8px; font-size: 11px; font-weight: 600;
  }

  /* MAP SCREEN */
  #map-screen { display: none; position: fixed; inset: 0; flex-direction: column; }
  #surveyor-map { flex: 1; }

  /* TOP BAR */
  .map-topbar {
    position: absolute; top: 0; left: 0; right: 0; z-index: 1000;
    background: linear-gradient(to bottom, rgba(15,17,23,0.95), transparent);
    padding: 12px 16px 24px;
    display: flex; align-items: flex-start; gap: 12px;
  }
  .back-btn {
    width: 36px; height: 36px; background: var(--panel); border: 1px solid var(--border);
    border-radius: 8px; display: flex; align-items: center; justify-content: center;
    cursor: pointer; font-size: 16px; flex-shrink: 0;
  }
  .village-info-pill {
    background: var(--panel); border: 1px solid var(--border);
    border-radius: 10px; padding: 8px 14px;
  }
  .vip-name { font-size: 15px; font-weight: 700; }
  .vip-meta { font-size: 11px; color: var(--muted); }

  /* BOTTOM PANEL */
  .map-bottom {
    position: absolute; bottom: 0; left: 0; right: 0; z-index: 1000;
    background: linear-gradient(to top, rgba(15,17,23,0.98) 60%, transparent);
    padding: 24px 16px 20px;
  }
  .stats-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 14px; }
  .stat-card {
    background: var(--card); border: 1px solid var(--border);
    border-radius: 10px; padding: 10px 12px;
  }
  .stat-label { font-size: 10px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; }
  .stat-value { font-size: 18px; font-weight: 700; margin-top: 2px; }
  .offline-badge {
    display: flex; align-items: center; gap: 8px;
    background: var(--card); border: 1px solid var(--border);
    border-radius: 8px; padding: 10px 14px;
  }
  .ob-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--success); flex-shrink: 0; }
  .ob-dot.offline { background: var(--warn); }
  .ob-text { font-size: 13px; color: var(--muted); }

  .empty-state { text-align: center; padding: 60px 20px; color: var(--muted); }
  .empty-state .es-icon { font-size: 48px; margin-bottom: 16px; }

  .toast {
    position: fixed; bottom: 120px; left: 50%; transform: translateX(-50%);
    background: var(--card); border: 1px solid var(--border); border-radius: 10px;
    padding: 12px 24px; font-size: 14px; font-weight: 500;
    z-index: 9999; opacity: 0; transition: opacity 0.3s; pointer-events: none; white-space: nowrap;
  }
  .toast.show { opacity: 1; }
  .toast.success { border-color: var(--success); color: var(--success); }
  .toast.error { border-color: var(--danger); color: var(--danger); }
</style>
</head>
<body>

<!-- SPLASH -->
<div id="splash">
  <div class="splash-icon">üåæ</div>
  <div class="splash-title">FarmMap</div>
  <div class="splash-sub">Surveyor App</div>
  <div class="spinner"></div>
</div>

<!-- SELECT VILLAGE -->
<div id="select-screen">
  <div class="ss-header">
    <div>
      <h2>Select Village</h2>
      <p>Choose the village you're surveying today</p>
    </div>
  </div>
  <div class="ss-body">
    <input class="search-box" id="village-search" placeholder="üîç  Search village name..." oninput="filterVillages()"/>
    <div id="village-items"></div>
  </div>
</div>

<!-- MAP -->
<div id="map-screen">
  <div id="surveyor-map"></div>

  <div class="map-topbar">
    <div class="back-btn" onclick="backToSelect()">‚Üê</div>
    <div class="village-info-pill">
      <div class="vip-name" id="sv-name">‚Äî</div>
      <div class="vip-meta" id="sv-meta">‚Äî</div>
    </div>
  </div>

  <div class="map-bottom">
    <div class="stats-row">
      <div class="stat-card">
        <div class="stat-label">Zoom</div>
        <div class="stat-value" id="stat-zoom">‚Äî</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Basemap</div>
        <div class="stat-value" style="font-size:13px; padding-top:4px" id="stat-source">Sentinel-2</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Boundary</div>
        <div class="stat-value" style="font-size:13px; padding-top:4px" id="stat-boundary">‚Äî</div>
      </div>
    </div>
    <div class="offline-badge">
      <div class="ob-dot" id="ob-dot"></div>
      <div class="ob-text" id="ob-text">Checking connection...</div>
    </div>
  </div>
</div>

<div class="toast" id="s-toast"></div>

<script src="config.js"></script>
<script>
let sMap, boundaryLayer, villages = [], filteredVillages = [];
let db = null;
let currentVillage = null;

async function init() {
  const cfg = getConfig();
  if (cfg?.supabaseUrl && cfg?.supabaseKey) {
    db = supabaseClient(cfg.supabaseUrl, cfg.supabaseKey);
    await loadVillages();
  }

  // If no DB, show select screen with empty state
  setTimeout(() => {
    document.getElementById('splash').style.display = 'none';
    document.getElementById('select-screen').style.display = 'flex';
  }, 1200);

  monitorConnection();
  registerSW();
}

async function loadVillages() {
  if (!db) return;
  try {
    const data = await db.from('villages').select('*');
    if (Array.isArray(data)) {
      villages = data.filter(v => v.boundary_geojson);
      filteredVillages = villages;
      renderVillages(filteredVillages);
    }
  } catch(e) { console.error(e); }
}

function filterVillages() {
  const q = document.getElementById('village-search').value.toLowerCase();
  filteredVillages = villages.filter(v =>
    v.name.toLowerCase().includes(q) ||
    (v.district || '').toLowerCase().includes(q) ||
    (v.state || '').toLowerCase().includes(q)
  );
  renderVillages(filteredVillages);
}

function renderVillages(list) {
  const container = document.getElementById('village-items');
  if (!list.length) {
    container.innerHTML = `<div class="empty-state">
      <div class="es-icon">üèòÔ∏è</div>
      <p>${villages.length === 0
        ? 'No villages configured.<br/>Ask your admin to add villages first.'
        : 'No villages match your search.'
      }</p>
    </div>`;
    return;
  }
  container.innerHTML = list.map(v => `
    <div class="village-item" onclick="openVillage('${v.id}')">
      <div class="vi-icon">üåæ</div>
      <div>
        <div class="vi-name">${v.name}</div>
        <div class="vi-meta">${[v.block, v.district, v.state].filter(Boolean).join(' ¬∑ ')}</div>
      </div>
      <div class="vi-status">
        <div class="vi-badge">‚úì Ready</div>
      </div>
    </div>
  `).join('');
}

function openVillage(id) {
  const v = villages.find(x => x.id == id);
  if (!v) return;
  currentVillage = v;

  document.getElementById('select-screen').style.display = 'none';
  document.getElementById('map-screen').style.display = 'flex';

  document.getElementById('sv-name').textContent = v.name;
  document.getElementById('sv-meta').textContent = [v.block, v.district, v.state].filter(Boolean).join(' ¬∑ ');

  setTimeout(() => initSurveyorMap(v), 50);
}

function initSurveyorMap(v) {
  if (sMap) { sMap.remove(); sMap = null; }

  const cfg = getConfig();
  sMap = L.map('surveyor-map', {
    zoomControl: false, attributionControl: false
  }).setView([20.5937, 78.9629], 13);

  // Basemap: use Mapbox satellite (representing Sentinel-2 backend)
  if (cfg?.mapboxToken) {
    L.tileLayer(
      `https://api.mapbox.com/styles/v1/mapbox/satellite-v9/tiles/{z}/{x}/{y}?access_token=${cfg.mapboxToken}`,
      { tileSize: 512, zoomOffset: -1, maxZoom: 22 }
    ).addTo(sMap);
    document.getElementById('stat-source').textContent = 'Satellite';
  } else if (cfg?.googleKey) {
    L.tileLayer(
      `https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}&key=${cfg.googleKey}`,
      { maxZoom: 22 }
    ).addTo(sMap);
    document.getElementById('stat-source').textContent = 'Google Sat';
  } else {
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(sMap);
    document.getElementById('stat-source').textContent = 'OSM';
  }

  // Draw boundary
  if (v.boundary_geojson) {
    boundaryLayer = L.geoJSON(v.boundary_geojson, {
      style: {
        color: '#00d4aa', weight: 3, opacity: 1,
        fillColor: '#00d4aa', fillOpacity: 0.1
      }
    }).addTo(sMap);
    sMap.fitBounds(boundaryLayer.getBounds(), { padding: [80, 80] });
    document.getElementById('stat-boundary').textContent = '‚úì Loaded';
  }

  sMap.on('zoomend', () => {
    document.getElementById('stat-zoom').textContent = sMap.getZoom();
  });
  document.getElementById('stat-zoom').textContent = sMap.getZoom();

  showSToast('Village loaded ‚Äî boundary overlaid', 'success');
}

function backToSelect() {
  document.getElementById('map-screen').style.display = 'none';
  document.getElementById('select-screen').style.display = 'flex';
  if (sMap) { sMap.remove(); sMap = null; }
}

function monitorConnection() {
  function update() {
    const online = navigator.onLine;
    document.getElementById('ob-dot').className = 'ob-dot' + (online ? '' : ' offline');
    document.getElementById('ob-text').textContent = online
      ? 'Online ‚Äî tiles will be cached for offline use'
      : 'Offline mode ‚Äî using cached data';
  }
  update();
  window.addEventListener('online', update);
  window.addEventListener('offline', update);
}

function registerSW() {
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/sw.js').catch(console.error);
  }
}

let sToastTimer;
function showSToast(msg, type = 'success') {
  const t = document.getElementById('s-toast');
  t.textContent = msg;
  t.className = `toast ${type} show`;
  clearTimeout(sToastTimer);
  sToastTimer = setTimeout(() => t.classList.remove('show'), 3000);
}

init();
</script>
</body>
</html>
